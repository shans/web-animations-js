<style>
.anim {
  width: 100px;
  height: 100px;
  background-color: red;
  position: absolute;
  top: 300px;
  left: 100px;
}
</style>
<textarea name='input' rows='10' cols='40'>
scale: '2, 2'
transform: 'rotate(40deg)'
</textarea>
<select id='whichFirst' name='whichFirst'>
  <option value='aggregateFirst' label='aggregate transform first'>Aggregate transform first</option>
  <option value='componentsFirst' label='transform components first'>Transform components first</option>
</select>
<button id='playMe'>Play that funky anim</button>
<div class='anim'></div>
<script src='web-animations.js'></script>
<script>

function compositeRotation(property, underlyingValue, value) {
  return underlyingValue + Number(value);
}

var anim = document.querySelector('.anim')

var aggregateFirst = whichFirst.value == 'aggregateFirst';
whichFirst.onchange = function(e) {
  aggregateFirst = whichFirst.value == 'aggregateFirst';
}

var t = true;

playMe.onclick = function(e) {
  document.timeline.play(new Animation(anim, [{ scale: 'scale(2, 2)' }, { rotate: 'rotate(45deg)' }, 
        { transform: 'translate(20px) rotate(45deg)', translate: 'translate(100px, 100px)'} ], 0.1));
}
  

function createCustomChannel(matchesType, defaultBase) {
  return {
    setValue: function(target, property, value) {
      target.setAttribute(property, value);
    },
    getValue: function(target, property) {
      var v = target.getAttribute(property);
      if (v) {
        return v;
      }
      return defaultBase;
    },
    clearValue: function(target, property) {
      target.removeAttribute(property);
    },
    matchesType: matchesType
  }
}

registerCustomChannel('rotate', createCustomChannel('transform', 'rotate(0deg)'));
registerCustomChannel('translate', createCustomChannel('transform', 'translate(0px, 0px)'));
registerCustomChannel('scale', createCustomChannel('transform', 'scale(1, 1)'));
registerCustomChannel('transform', createCustomChannel('transform', ''));

function resolve() {
  var rotate = anim.getAttribute('rotate');
  var translate = anim.getAttribute('translate');
  var scale = anim.getAttribute('scale');
  var transform = anim.getAttribute('transform');
  // TODO: work out why the first frame is incorrect.
  if (translate) {
    anim.style.webkitTransform = (aggregateFirst ? transform + ' ' : '' ) 
      + translate + ' ' + rotate + ' ' + scale 
      + (aggregateFirst ? '' : ' ' + transform);
  }
  
}

postComposite(resolve);

  

</script>
